# @connected-repo/zod-schemas

Shared Zod validation schemas for backend/frontend consistency

## Purpose
- Entity schemas with structured pattern
- Database-aligned validators (Orchid ORM types)
- Business validators (price, quantity, amount)
- Indian compliance (GSTIN, PAN, Udyog Aadhaar)
- Contact & location validators

## Entity Pattern

**File**: `<entity>.zod.ts` (user.zod.ts, post.zod.ts)

**Components**:
1. `<entity>MandatoryZod` - Required fields
2. `<entity>OptionalZod` - Optional/nullable fields
3. `<entity>AutoGeneratedZod` - DB-generated (IDs, timestamps)
4. `<entity>CreateInputZod` - Create input
5. `<entity>UpdateInputZod` - Update input (all partial)
6. `<entity>SelectAllZod` - Complete entity
7. Query schemas - `<entity>GetByIdZod`, etc.

**Example**:
```typescript
import z from 'zod';
import { zString, zTimestamps } from './zod_utils.js';

export const userMandatoryZod = z.object({ email: z.email() });
export const userOptionalZod = z.object({ name: zString.nullable() });
const userAutoGeneratedZod = z.object({ userId: z.uuid() });

export const userCreateInputZod = userMandatoryZod.extend(userOptionalZod.partial().shape);
export const userUpdateInputZod = userMandatoryZod.extend(userOptionalZod.shape).extend(zTimestamps).partial();
export const userSelectAllZod = userMandatoryZod.extend(userOptionalZod.shape).extend(zTimestamps).extend(userAutoGeneratedZod.shape);

export const userGetByIdInputZod = z.object({ userId: z.uuid() });
```

**Naming**: IDs (`userId`, `postId`), FKs (`authorUserId`), Schemas (`userCreateInputZod`)

## Structure
```
src/
├── user.zod.ts     # User schemas
├── post.zod.ts     # Post schemas
├── node_env.ts     # Environment enum
└── zod_utils.ts    # Reusable validators
```

## Imports

**External** (from apps):
```typescript
import { userCreateInputZod } from '@connected-repo/zod-schemas/user.zod'
import { zString, zPrice, zTimestamps } from '@connected-repo/zod-schemas/zod_utils'
import { NodeEnv } from '@connected-repo/zod-schemas/node_env'
```

**Internal** (within zod-schemas):
```typescript
// ✅ Relative
import { zString, zTimestamps } from './zod_utils.js';

// ❌ Package alias
import { zString } from '@connected-repo/zod-schemas/zod_utils';
```

## Validators

### Base
```typescript
zString                                    // z.string().trim()
zVarchar(min?, max?)                       // Default: 0-255
zText(min?)                                // Long text, no max
```

### Numeric
```typescript
zSmallint(min?, max?)                      // -32,768 to 32,767
zInteger(min?, max?)                       // Standard int
zDecimal(precision, scale, min?, max?)     // Custom decimal (returns string)
```

### Business
```typescript
zPrice                                     // Decimal(10,2), min 0.01
zQuantity                                  // Decimal(11,3), min 0.001
zAmount(min?, max?)                        // Decimal(15,2)
```

### Compliance (India)
```typescript
zGSTIN                                     // 15-char with checksum
zPAN                                       // 10-char format
zUdyogAadhaar                              // 12-char
zUdyamRegistrationNumber                   // 19-char
```

### Contact
```typescript
zPhoneNumber                               // International, 10-15 digits
```

### Location
```typescript
zLatitude                                  // -90 to +90, 6 decimals
zLongitude                                 // -180 to +180, 6 decimals
```

### Timestamps
```typescript
zTimestamps                                // { createdAt: number, updatedAt: number }
```

### Environment
```typescript
import { NodeEnv } from '@connected-repo/zod-schemas/node_env'
// 'development' | 'production' | 'staging' | 'test'
```

## Usage

**Basic**:
```typescript
import { zVarchar, zPrice, zQuantity } from '@connected-repo/zod-schemas/zod_utils'

const productSchema = z.object({
  name: zVarchar(3, 100),
  price: zPrice,
  quantity: zQuantity,
})
```

**With Timestamps**:
```typescript
import { zTimestamps } from '@connected-repo/zod-schemas/zod_utils'

const userSchema = z.object({
  name: zVarchar(2, 50),
  ...zTimestamps,
})
```

**Compliance**:
```typescript
import { zGSTIN, zPAN } from '@connected-repo/zod-schemas/zod_utils'

const businessSchema = z.object({
  gstin: zGSTIN,
  pan: zPAN,
})
```

**Optional/Nullable**:
```typescript
zGSTIN.optional()           // Optional
zVarchar(1, 50).nullable()  // Can be null
zInteger(0).default(1)      // Default value
```

**Refinements**:
```typescript
zVarchar(8, 100).refine(
  (val) => /[A-Z]/.test(val),
  { message: 'Must contain uppercase' }
)
```

**Security - Omit Sensitive**:
```typescript
export const teamSelectAllZod = teamMandatoryZod
  .extend(teamOptionalZod.shape)
  .extend(teamAutoGeneratedZod.shape)
  .omit({ apiSecretHash: true });
```

## Adding Entities

Create `src/<entity>.zod.ts`:
```typescript
import z from 'zod';
import { zString, zTimestamps, zPrice } from './zod_utils.js';

export const productMandatoryZod = z.object({
  name: zString.min(1),
  price: zPrice,
});

export const productOptionalZod = z.object({
  description: zString.nullable(),
});

const productAutoGeneratedZod = z.object({
  productId: z.uuid(),
});

export const productCreateInputZod = productMandatoryZod.extend(productOptionalZod.partial().shape);
export const productUpdateInputZod = productMandatoryZod.extend(productOptionalZod.shape).extend(zTimestamps).partial();
export const productSelectAllZod = productMandatoryZod.extend(productOptionalZod.shape).extend(zTimestamps).extend(productAutoGeneratedZod.shape);

export const productGetByIdZod = z.object({ productId: z.uuid() });
```

Then:
1. Add backend table: `apps/backend/src/db/tables/product.table.ts`
2. Register in `apps/backend/src/db/db.ts`
3. Import in router
4. `yarn build`

## Adding Validators

In `zod_utils.ts`:
```typescript
export const zEmail = zString.email().toLowerCase()
```

Rebuild: `yarn build`

## Type Inference
```typescript
const schema = z.object({ name: zVarchar(1, 50), price: zPrice })
type Inferred = z.infer<typeof schema>
// { name: string; price: string }
// Note: zPrice returns string for decimal precision
```

## Error Handling
```typescript
const result = zGSTIN.safeParse('INVALID')
if (!result.success) {
  console.error(result.error.issues)
}
```

## Limitations
1. zDecimal precision check: May not handle scientific notation correctly
2. GSTIN: Format/checksum only, not registration status
3. Phone: Basic format, doesn't verify carrier/country

## Best Practices
1. ✅ Use DB-aligned validators
2. ✅ Combine with .optional(), .nullable(), .default()
3. ✅ Export schema & type
4. ✅ Use .safeParse() for error handling
5. ❌ NO `any` or type assertions

## Dev
```bash
yarn build      # Build
yarn dev        # Watch
yarn typecheck  # Type check
yarn lint       # Lint
```
