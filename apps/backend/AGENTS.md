# Backend Agent Guidelines

## Commands
- **Dev**: `yarn dev`, `yarn dev:inspect`
- **Build**: `yarn build`
- **DB**: `yarn db g <name>`, `yarn db up`, `yarn db seed`, `yarn test:db:setup`
- **Tests**: `yarn test`, `yarn test:ui`, `yarn test:coverage`

## Stack
Fastify, oRPC (type-safe APIs), Orchid ORM (PostgreSQL), Better Auth (Google OAuth), Vitest (tests), OpenTelemetry, Sentry

## Structure
```
src/
├── modules/          # Features: auth, journal-entries, prompts, logs, subscriptions, teams, users, webhook_calls
├── routers/          # user_app/ - oRPC routes, open_api/ - external APIs, cron_jobs/ - cron jobs
├── procedures/       # public, protected, sensitive, open_api_auth, cron_job_auth
├── middlewares/      # API key auth, IP whitelist, session security, cron job auth
├── db/              # Tables, migrations, seeds
└── server.ts        # Entry
```

## Database Tables

**Create Table** (`modules/<module>/tables/<entity>.table.ts`):
```typescript
import { BaseTable } from '../../../db/base_table';

export class JournalEntriesTable extends BaseTable {
  readonly table = 'journal_entries';
  columns = this.setColumns((t) => ({
    journalEntryId: t.uuid().primaryKey().default(t.sql`gen_random_uuid()`),
    authorUserId: t.uuid().foreignKey('users', 'userId'),
    content: t.text(),
    ...this.baseTableColumns(t),  // createdAt, updatedAt
  }));
}
```

**Rules**:
- Descriptive IDs: `userId`, `journalEntryId` (not `id`)
- Descriptive FKs: `authorUserId` (not `authorId`)
- Use `timestampNumber` for timestamps (epoch ms)
- snake_case columns, PascalCase class

**Zod Schemas** (`packages/zod-schemas/src/<entity>.zod.ts`):
```typescript
import z from 'zod';
import { zString, zTimestamps } from './zod_utils.js';

export const journalEntryMandatoryZod = z.object({
  content: zString.min(1),
});

export const journalEntryOptionalZod = z.object({
  mood: zString.nullable(),
});

const journalEntryAutoGeneratedZod = z.object({
  journalEntryId: z.string().uuid(),
  authorUserId: z.string().uuid(),
});

export const journalEntryCreateInputZod = journalEntryMandatoryZod.extend(
  journalEntryOptionalZod.partial().shape
);

export const journalEntryUpdateInputZod = journalEntryMandatoryZod
  .extend(journalEntryOptionalZod.shape)
  .extend(zTimestamps)
  .partial();

export const journalEntrySelectAllZod = journalEntryMandatoryZod
  .extend(journalEntryOptionalZod.shape)
  .extend(zTimestamps)
  .extend(journalEntryAutoGeneratedZod.shape);
```

**Register** in `db/db.ts`, generate migration: `yarn db g <name>`, run: `yarn db up`

## oRPC Endpoints

**Create Procedure** (`modules/<module>/<module>.router.ts`):
```typescript
import { rpcProtectedProcedure } from '../../procedures/protected.procedure';
import { journalEntryCreateInputZod } from '@connected-repo/zod-schemas/journal_entry.zod';
import { db } from '../../db/db';

export const createJournalEntry = rpcProtectedProcedure
  .input(journalEntryCreateInputZod)
  .handler(async ({ input, context }) => {
    return db.journalEntries.create({
      ...input,
      authorUserId: context.user.id,
    });
  });
```

**Procedures**:
- `rpcPublicProcedure`: No auth
- `rpcProtectedProcedure`: Requires session & user
- `rpcSensitiveProcedure`: Extra security

**Register** in `routers/user_app/user_app.router.ts`

## Testing

**Setup**: `yarn test:db:setup` (drop, create, migrate, seed test DB)

**Test** (`modules/<module>/<module>.test.ts`):
```typescript
import { beforeAll, describe, expect, test } from 'vitest';
import { db } from '../../db/db';
import { createTestUserAndSession } from '../../test/utils/user-auth.utils';

describe('Journal Entries', () => {
  let userId: string;

  beforeAll(async () => {
    const result = await createTestUserAndSession(db);
    userId = result.userId;
  });

  test('create', async () => {
    const entry = await db.journalEntries.create({
      content: 'Test',
      authorUserId: userId,
    });
    expect(entry.journalEntryId).toBeDefined();
  });
});
```

## Auth

**Better Auth**: Google OAuth in `modules/auth/auth.config.ts`, custom Orchid adapter
**Auth Middleware**: Validates session & user in `modules/auth/auth.middleware.ts`
**API Key Auth**: Scrypt-hashed team API keys in `middlewares/api-key-auth.middleware.ts`
**Cron Job Auth**: Bearer token auth in `middlewares/cron-job-auth.middleware.ts`

## Error Handling

**Error Parser** (`utils/errorParser.ts`): Converts DB/validation errors to user-friendly messages
**Usage**: `throw new Error(handleErrors(error))`
**oRPC**: Auto-catches and formats errors

## Cron Jobs Authentication

**Procedure** (`procedures/cron_job_auth.procedure.ts`):
```typescript
export const cronJobAuthProcedure = openApiPublicProcedure
  .use(cronJobAuthMiddleware);
```

**Middleware** (`middlewares/cron-job-auth.middleware.ts`):
```typescript
// Checks Authorization: Bearer <CRON_JOB_TOKEN>
if (authorization !== `Bearer ${env.CRON_JOB_TOKEN}`) {
  throw new ORPCError("UNAUTHORIZED", { status: 401, message: "Invalid Authorization token" });
}
```

## Webhook Processing

**Queue Table** (`modules/webhook_calls/tables/webhookCallQueue.table.ts`): Stores pending/failed webhook calls with retry logic
**Service** (`modules/webhook_calls/services/initiate.webhook_calls.service.ts`): Sends webhook with Bearer token, updates status
**Cron Job** (`routers/cron_jobs/cron_jobs.router.ts`): Processes pending webhooks in batches (100 at a time)

## OpenAPI Endpoints

**Procedure** (`procedures/open_api_auth.procedure.ts`): API key + team ID auth, CORS, rate limiting, subscription checks
**Router** (`routers/open_api/open_api.router.ts`): External REST APIs with Swagger docs at `/api/documentation`
**Request Logging**: All API calls logged to `api_product_request_logs` table
**Subscription Usage**: Atomic increment with 90% threshold alerts via webhooks

**Create Endpoint** (`modules/<module>/<module>.openapi.router.ts`):
```typescript
const createRequest = openApiAuthProcedure
  .route({ method: "POST", tags: ["<Module>"] })
  .input(openapiCreateInputZod)
  .output(apiProductRequestLogSelectAllZod)
  .handler(async ({ context: { team }, input }) => {
    const logEntry = await createRequestLog(input, reqHeaders, path, team.teamId);
    const { subscription } = await checkSubscriptionAndUpdateLog(logEntry, "product", sku, teamId, userRef);
    if (!subscription) return logEntry;

    await incrementSubscriptionUsage(subscription.subscriptionId, team);
    // Process request
    return logEntry;
  });
```

**Response Endpoint**:
```typescript
const getResponse = openApiAuthProcedure
  .route({ method: "GET", tags: ["<Module>"] })
  .input(z.object({ requestId: z.string() }))
  .output(responseZod)
  .handler(async ({ context: { team }, input: { requestId } }) => {
    return db.apiProductRequestLogs.find(requestId).where({ teamId: team.teamId });
  });
```

## Environment

**Config**: `configs/env.config.ts` (Zod validation)
**Key Vars**: `NODE_ENV`, `DATABASE_URL`, `DATABASE_URL_TEST`, `GOOGLE_CLIENT_ID/SECRET`, `BETTER_AUTH_SECRET`

## Common Patterns

**Create with Author**:
```typescript
export const createEntry = rpcProtectedProcedure
  .input(entryCreateInputZod)
  .handler(async ({ input, context }) => {
    return db.entries.create({ ...input, authorUserId: context.user.id });
  });
```

**Query with User Filter**:
```typescript
export const getUserEntries = rpcProtectedProcedure
  .handler(async ({ context }) => {
    return db.entries.where({ authorUserId: context.user.id });
  });
```

**Update with Ownership**:
```typescript
export const updateEntry = rpcProtectedProcedure
  .input(entryUpdateInputZod)
  .handler(async ({ input, context }) => {
    const entry = await db.entries.findBy({ journalEntryId: input.id });
    if (entry.authorUserId !== context.user.id) throw new Error('Unauthorized');
    return db.entries.find(input.id).update(input);
  });
```

**Transaction**:
```typescript
await db.$transaction(async (tx) => {
  await tx.entries.create(entryData);
  await tx.logs.create(logData);
});
```

**Increment Subscription Usage**:
```typescript
import { incrementSubscriptionUsage } from '../subscriptions/services/increment_usage.subscriptions.service';

await incrementSubscriptionUsage(subscriptionId, team);  // Atomic increment, queues webhook at 90%
```

## Best Practices
- NO `any` or `as unknown`
- Infer types from Zod
- Direct imports, NO barrel exports
- Test all CRUD ops
- Use transactions for multi-table ops
- Index frequently queried columns
- Hash sensitive data (scrypt for API keys)
- Log with appropriate level
