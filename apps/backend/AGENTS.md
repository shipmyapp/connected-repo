# Backend Agent Guidelines

## Commands
- **Dev**: `yarn dev`, `yarn dev:inspect`
- **Build**: `yarn build`
- **DB**: `yarn db g <name>`, `yarn db up`, `yarn db seed`, `yarn test:db:setup`
- **Tests**: `yarn test`, `yarn test:ui`, `yarn test:coverage`

## Stack
oRPC, Orchid ORM (PostgreSQL), pg-tbus, Better Auth, SuprSend, SSE streaming, Orchid hooks

## Structure
```
src/
├── modules/          # Features: auth, journal-entries, prompts, logs, subscriptions, teams, cdn, sync
├── routers/          # user_app/ (oRPC), open_api/ (REST), cron_jobs/
├── procedures/       # public, protected, sensitive, open_api_public, cron_job_auth
├── middlewares/      # API key auth, IP whitelist, session security, cron job auth
├── events/           # pg-tbus events & tasks
├── cron_jobs/        # Cron job handlers
├── db/              # Tables with ORM hooks
└── server.ts        # Entry
```

## Database

**Create Table** (`modules/<module>/tables/<entity>.table.ts`):
```typescript
export class EntityTable extends BaseTable {
  readonly table = 'entity_name';
  columns = this.setColumns((t) => ({
    entityId: t.uuid().primaryKey().default(t.sql`gen_random_uuid()`),
    authorUserId: t.uuid().foreignKey('users', 'userId'),
    ...this.baseTableColumns(t),
  }));
  
  // Sync hooks for real-time updates
  init() {
    this.afterCreate(schema.keyof().options, (entries) => {
      pushToSync("create", entries);
    });
  }
}
```

**Rules**: Descriptive IDs (`userId`, not `id`), snake_case columns, PascalCase class, `timestampNumber` for timestamps

**Zod Schemas** (`packages/zod-schemas/src/<entity>.zod.ts`):
```typescript
export const entityMandatoryZod = z.object({ name: zString.min(1) });
export const entityOptionalZod = z.object({ description: zString.nullable() });
export const entityCreateInputZod = entityMandatoryZod.extend(entityOptionalZod.partial().shape);
export const entityUpdateInputZod = entityMandatoryZod.extend(entityOptionalZod.shape).extend(zTimestamps).partial();
export const entitySelectAllZod = entityMandatoryZod.extend(entityOptionalZod.shape).extend(zTimestamps).extend(entityAutoGeneratedZod.shape);
```

**Register** in `db/db.ts`, generate: `yarn db g <name>`

## Migrations (CRITICAL)

**Always auto-generate**:
```bash
yarn db g <migration_name>   # ALWAYS use this
yarn db up                   # Apply
```

**Backward compatible only**:
- Add nullable/default columns (never required)
- Two-step deletion: stop using first, drop in later release
- Never rename columns in single deployment

## oRPC Endpoints

```typescript
export const createEntity = rpcProtectedProcedure
  .input(entityCreateInputZod)
  .handler(async ({ input, context }) => {
    return db.entities.create({ ...input, authorUserId: context.user.id });
  });
```

**Procedures**: `rpcPublicProcedure`, `rpcProtectedProcedure`, `rpcSensitiveProcedure`

**Register** in `routers/user_app/user_app.router.ts`

## Events & Tasks (pg-tbus)

```typescript
// Define
export const entityCreatedEventDef = defineEvent({
  event_name: "entity.created",
  schema: Type.Object({ entityId: Type.String(), userId: Type.String() }),
});

export const taskDef = defineTask({
  task_name: "process_entity",
  schema: Type.Object({ entityId: Type.String() }),
  config: { retryLimit: 3, retryDelay: 10, retryBackoff: true },
});

// Emit
await tbus.emit(entityCreatedEventDef, { entityId: "123", userId: "456" });

// Register handler (events/queries.ts)
tbus.on(entityCreatedEventDef, async ({ payload }) => {
  await handleEntityCreated(payload);
});
```

## Delta Sync & SSE

**Purpose**: Real-time sync to offline-first clients

**Router** (`modules/sync/sync.router.ts`):
```typescript
// Streaming oRPC endpoint sends deltas then heartbeats
async function* streamSync(input) {
  // 1. Send delta chunks (cursor-based pagination)
  for (const chunk of getDeltas(since)) {
    yield { type: "delta", table, data, isLastChunk };
  }
  // 2. Transition to live monitoring
  while (connected) {
    yield { type: "heartbeat", timestamp: Date.now() };
    await sleep(10000);
  }
}
```

**ORM Hooks trigger sync** (`tables/*.table.ts`):
```typescript
this.afterCreate(schema.keyof().options, (entries) => {
  pushToSync("create", entries);
});
```

## Cron Jobs

```typescript
let isCronJobRunning = false;
export const perMinuteCronJobs = cron.schedule('* * * * *', async () => {
  if (isCronJobRunning) return;
  isCronJobRunning = true;
  try {
    await runScheduledTasks();
  } finally {
    isCronJobRunning = false;
  }
});
```

**Mutex pattern** prevents concurrent execution

## Testing

```typescript
import { createTestUserAndSession } from '../../test/utils/user-auth.utils';

describe('Module', () => {
  let userId: string;
  beforeAll(async () => {
    userId = (await createTestUserAndSession(db)).userId;
  });
  
  test('create', async () => {
    const entity = await db.entities.create({ name: 'Test', authorUserId: userId });
    expect(entity.entityId).toBeDefined();
  });
});
```

## Auth & Teams

**Dual Team Model**:
- `teams_app`: UI teams (session auth)
- `teams_api`: API keys for external access

**Auth**: Better Auth (Google OAuth) in `modules/auth/`
**API Key**: Scrypt-hashed in `middlewares/api-key-auth.middleware.ts`

## CDN & File Uploads

**Presigned URLs** (`modules/cdn/`):
```typescript
const command = new PutObjectCommand({ Bucket, Key, ContentType });
const signedUrl = await getSignedUrl(s3Client, command, { expiresIn: 900 });
```

## OpenAPI Endpoints

```typescript
const endpoint = openApiPublicProcedure
  .route({ method: "POST", tags: ["Module"] })
  .input(openapiInputZod)
  .output(outputZod)
  .handler(async ({ context: { team }, input }) => {
    const log = await createRequestLog(input, headers, path, team.teamId);
    await incrementSubscriptionUsage(team.subscriptionId, team);
    // Process
    return log;
  });
```

## Common Patterns

**Create with Author**:
```typescript
return db.entities.create({ ...input, authorUserId: context.user.id });
```

**Transaction**:
```typescript
await db.$transaction(async (tx) => {
  await tx.entities.create(data);
  await tx.logs.create(logData);
});
```

**Soft Delete**:
```typescript
await db.entities.find(id).update({ deletedAt: Date.now() });
```

## Best Practices
- NO `any` or `as unknown`
- Infer types from Zod
- Direct imports, NO barrel exports
- Test all CRUD ops
- Use transactions for multi-table ops
- Hash sensitive data (scrypt)
- Always auto-generate migrations
- Use ORM hooks to trigger sync events
- Implement soft delete for sync compatibility
