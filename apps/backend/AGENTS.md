# Backend Agent Guidelines

## Commands
- **Dev**: `yarn dev`, `yarn dev:inspect`
- **Build**: `yarn build`
- **DB**: `yarn db g <name>`, `yarn db up`, `yarn db seed`, `yarn test:db:setup`
- **Tests**: `yarn test`, `yarn test:ui`, `yarn test:coverage`

## Stack
Fastify, oRPC (type-safe APIs), Orchid ORM (PostgreSQL), Better Auth (Google OAuth), Vitest (tests), OpenTelemetry, Sentry

## Structure
```
src/
├── modules/          # Features: auth, journal-entries, prompts, teams, users
├── routers/          # user_app/ - oRPC routes
├── procedures/       # public, protected, sensitive
├── middlewares/      # API key auth, IP whitelist, session security
├── db/              # Tables, migrations, seeds
└── server.ts        # Entry
```

## Database Tables

**Create Table** (`modules/<module>/tables/<entity>.table.ts`):
```typescript
import { BaseTable } from '../../../db/base_table';

export class JournalEntriesTable extends BaseTable {
  readonly table = 'journal_entries';
  columns = this.setColumns((t) => ({
    journalEntryId: t.uuid().primaryKey().default(t.sql`gen_random_uuid()`),
    authorUserId: t.uuid().foreignKey('users', 'userId'),
    content: t.text(),
    ...this.baseTableColumns(t),  // createdAt, updatedAt
  }));
}
```

**Rules**:
- Descriptive IDs: `userId`, `journalEntryId` (not `id`)
- Descriptive FKs: `authorUserId` (not `authorId`)
- Use `timestampNumber` for timestamps (epoch ms)
- snake_case columns, PascalCase class

**Zod Schemas** (`packages/zod-schemas/src/<entity>.zod.ts`):
```typescript
import z from 'zod';
import { zString, zTimestamps } from './zod_utils.js';

export const journalEntryMandatoryZod = z.object({
  content: zString.min(1),
});

export const journalEntryOptionalZod = z.object({
  mood: zString.nullable(),
});

const journalEntryAutoGeneratedZod = z.object({
  journalEntryId: z.string().uuid(),
  authorUserId: z.string().uuid(),
});

export const journalEntryCreateInputZod = journalEntryMandatoryZod.extend(
  journalEntryOptionalZod.partial().shape
);

export const journalEntryUpdateInputZod = journalEntryMandatoryZod
  .extend(journalEntryOptionalZod.shape)
  .extend(zTimestamps)
  .partial();

export const journalEntrySelectAllZod = journalEntryMandatoryZod
  .extend(journalEntryOptionalZod.shape)
  .extend(zTimestamps)
  .extend(journalEntryAutoGeneratedZod.shape);
```

**Register** in `db/db.ts`, generate migration: `yarn db g <name>`, run: `yarn db up`

## oRPC Endpoints

**Create Procedure** (`modules/<module>/<module>.router.ts`):
```typescript
import { rpcProtectedProcedure } from '../../procedures/protected.procedure';
import { journalEntryCreateInputZod } from '@connected-repo/zod-schemas/journal_entry.zod';
import { db } from '../../db/db';

export const createJournalEntry = rpcProtectedProcedure
  .input(journalEntryCreateInputZod)
  .handler(async ({ input, context }) => {
    return db.journalEntries.create({
      ...input,
      authorUserId: context.user.id,
    });
  });
```

**Procedures**:
- `rpcPublicProcedure`: No auth
- `rpcProtectedProcedure`: Requires session & user
- `rpcSensitiveProcedure`: Extra security

**Register** in `routers/user_app/user_app.router.ts`

## Testing

**Setup**: `yarn test:db:setup` (drop, create, migrate, seed test DB)

**Test** (`modules/<module>/<module>.test.ts`):
```typescript
import { beforeAll, describe, expect, test } from 'vitest';
import { db } from '../../db/db';
import { createTestUserAndSession } from '../../test/utils/user-auth.utils';

describe('Journal Entries', () => {
  let userId: string;

  beforeAll(async () => {
    const result = await createTestUserAndSession(db);
    userId = result.userId;
  });

  test('create', async () => {
    const entry = await db.journalEntries.create({
      content: 'Test',
      authorUserId: userId,
    });
    expect(entry.journalEntryId).toBeDefined();
  });
});
```

## Auth

**Better Auth**: Google OAuth in `modules/auth/auth.config.ts`, custom Orchid adapter
**Auth Middleware**: Validates session & user in `modules/auth/auth.middleware.ts`
**API Key Auth**: Scrypt-hashed team API keys in `middlewares/api-key-auth.middleware.ts`

## Error Handling

**Error Parser** (`utils/errorParser.ts`): Converts DB/validation errors to user-friendly messages
**Usage**: `throw new Error(handleErrors(error))`
**oRPC**: Auto-catches and formats errors

## Environment

**Config**: `configs/env.config.ts` (Zod validation)
**Key Vars**: `NODE_ENV`, `DATABASE_URL`, `DATABASE_URL_TEST`, `GOOGLE_CLIENT_ID/SECRET`, `BETTER_AUTH_SECRET`

## Common Patterns

**Create with Author**:
```typescript
export const createEntry = rpcProtectedProcedure
  .input(entryCreateInputZod)
  .handler(async ({ input, context }) => {
    return db.entries.create({ ...input, authorUserId: context.user.id });
  });
```

**Query with User Filter**:
```typescript
export const getUserEntries = rpcProtectedProcedure
  .handler(async ({ context }) => {
    return db.entries.where({ authorUserId: context.user.id });
  });
```

**Update with Ownership**:
```typescript
export const updateEntry = rpcProtectedProcedure
  .input(entryUpdateInputZod)
  .handler(async ({ input, context }) => {
    const entry = await db.entries.findBy({ journalEntryId: input.id });
    if (entry.authorUserId !== context.user.id) throw new Error('Unauthorized');
    return db.entries.find(input.id).update(input);
  });
```

**Transaction**:
```typescript
await db.$transaction(async (tx) => {
  await tx.entries.create(entryData);
  await tx.logs.create(logData);
});
```

## Best Practices
- NO `any` or `as unknown`
- Infer types from Zod
- Direct imports, NO barrel exports
- Test all CRUD ops
- Use transactions for multi-table ops
- Index frequently queried columns
- Hash sensitive data (scrypt for API keys)
- Log with appropriate level
